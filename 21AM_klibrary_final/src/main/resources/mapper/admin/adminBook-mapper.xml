<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="adminBook">
	
	<!-- isbn 중복검사 -->
	<select id="checkIsbn" parameterType="String" resultType="_int">
		SELECT COUNT(*) FROM BOOK_INFO WHERE ISBN_NO = #{isbnNo}
	</select>
	
	<!-- isbn 등록 -->
	<insert id="insertBookInfo" parameterType="bookInfo">
		INSERT INTO BOOK_INFO VALUES(#{isbnNo},#{bookName},#{bookWriter},#{bookCompany},#{bookDate},#{bookPrice},#{bookLocation},#{bookContent},#{bookImg},#{bookKdc})
	</insert>
	
	<!-- 도서 parsing -->
	<!-- <insert id="insertBookParsing" parameterType="Map">
		INSERT INTO BOOK_INFO_PARSING VALUES(SEQ_BOOK_PARSING_NO.NEXTVAL,#{isbnNo},#{bookParName},#{bookParWriter},#{bookParCompany})
	</insert> -->
	
	<!-- 도서등록 -->
	<insert id="insertBook" parameterType="bookInfo">
		INSERT INTO BOOK VALUES(SEQ_BOOK_NO.NEXTVAL,#{isbnNo},default,default)
	</insert>
	
	<!-- 도서목록 -->
	<select id="selectBookList" resultMap="bookMap">
		select * from BOOK JOIN BOOK_INFO USING(ISBN_NO) JOIN KDC_DETAIL ON(BOOK_KDC=KDC_DETAIL_NO) JOIN KDC_NO USING(KDC_NO)
	</select>
	
	<!-- 도서 상세 -->
	<select id="selectBook" parameterType="String" resultMap="bookMap">
		select * from BOOK JOIN BOOK_INFO USING(ISBN_NO) JOIN KDC_DETAIL ON(BOOK_KDC=KDC_DETAIL_NO) JOIN KDC_NO USING(KDC_NO) 
		WHERE BOOK_NO = #{bookNo}
	</select>
	
	<!-- 도서대출내역 -->
	<select id="selectLenHis" parameterType="String" resultMap="lenHisMap">
		SELECT * FROM LENDING_HISTORY
		WHERE BOOK_NO = #{bookNo}
	</select>
	
	<!-- 총도서 -->
	<select id="totalBook" resultType="_int">
		SELECT COUNT(*) FROM BOOK
	</select>
	
	<!-- 도서 Key 목록 -->
	<select id="searchKeyBook" parameterType="Map" resultMap="bookMap">
		SELECT * FROM BOOK JOIN BOOK_INFO USING(ISBN_NO) JOIN KDC_DETAIL ON(BOOK_KDC=KDC_DETAIL_NO) JOIN KDC_NO USING(KDC_NO) 
		WHERE ${searchOption} LIKE '%'||#{searchWord}||'%'
	</select>
	
	<!-- 도서 key 총 도서 -->
	<select id="totalKeyBook" parameterType="Map" resultType="_int">
		SELECT COUNT(*) FROM BOOK JOIN BOOK_INFO USING(ISBN_NO) JOIN KDC_DETAIL ON(BOOK_KDC=KDC_DETAIL_NO) JOIN KDC_NO USING(KDC_NO) 
		WHERE ${searchOption} LIKE '%'||#{searchWord}||'%'
	</select>
	
	<!-- 도서 Detail 목록 -->
	<select id="searchDetBook" parameterType="Map" resultMap="bookMap">
		SELECT * FROM BOOK JOIN BOOK_INFO USING(ISBN_NO) JOIN KDC_DETAIL ON(BOOK_KDC=KDC_DETAIL_NO) JOIN KDC_NO USING(KDC_NO) 
		WHERE 1=1
		
		<if test="iniArr != null and iniArr != ''">
		AND BOOK_NAME 
		<foreach collection="iniArr" item="i" open="BETWEEN" close="" separator="AND" >
				NCHR(#{i})
		</foreach> 
		</if>
		
		<if test="detBookName != null and detBookName != ''">
			AND BOOK_NAME LIKE '%'||#{detBookName}||'%'
		</if>
		<if test="detIsbn != null and detIsbn!= ''">
			AND ISBN_NO LIKE '%'||#{detIsbn}||'%'
		</if>
		<if test="detWriter != null and detWriter != ''">
			AND BOOK_WRITER LIKE '%'||#{detWriter}||'%'
		</if>
		<if test="detPublisher != null and detPublisher != ''">
			AND BOOK_COMPANY LIKE '%'||#{detPublisher}||'%'
		</if>
		<if test="detLow != null and detLow != '' and detHigh != null and detHigh!= '' ">
			AND BOOK_DATE BETWEEN #{detLow} AND #{detHigh}
		</if>
		<if test="detLow != null and detLow != '' and (detHigh == null or detHigh == '') ">
			AND BOOK_DATE BETWEEN #{detLow} AND SYSDATE
		</if>
		
	</select>
	
	<select id="totalDetBook" parameterType="Map" resultType="_int">
		SELECT COUNT(*) FROM BOOK JOIN BOOK_INFO USING(ISBN_NO) JOIN KDC_DETAIL ON(BOOK_KDC=KDC_DETAIL_NO) JOIN KDC_NO USING(KDC_NO) 
		WHERE 1=1
		
		<if test="iniArr != null and iniArr != ''">
		AND BOOK_NAME 
		<foreach collection="iniArr" item="i" open="BETWEEN" close="" separator="AND" >
				NCHR(#{i})
		</foreach> 
		</if>
		
		<if test="detBookName != null and detBookName != ''">
			AND BOOK_NAME LIKE '%'||#{detBookName}||'%'
		</if>
		<if test="detIsbn != null and detIsbn!= ''">
			AND ISBN_NO LIKE '%'||#{detIsbn}||'%'
		</if>
		<if test="detWriter != null and detWriter != ''">
			AND BOOK_WRITER LIKE '%'||#{detWriter}||'%'
		</if>
		<if test="detPublisher != null and detPublisher != ''">
			AND BOOK_COMPANY LIKE '%'||#{detPublisher}||'%'
		</if>
		<if test="detLow != null and detLow != '' and detHigh != null and detHigh!= '' ">
			AND BOOK_DATE BETWEEN #{detLow} AND #{detHigh}
		</if>
		<if test="detLow != null and detLow != '' and (detHigh == null or detHigh == '') ">
			AND BOOK_DATE BETWEEN #{detLow} AND SYSDATE
		</if>
		
	</select>
	
	<!-- 도서삭제 -->
	<delete id="deleteBook" parameterType="Map">
		DELETE FROM BOOK WHERE BOOK_NO IN 
		<foreach collection="bookNo" item="b" open="(" separator="," close=")">
			#{b}
		</foreach>
		   
	</delete>
	
	<!-- 대출도서 리스트 -->
	<select id="selectRentalList" resultMap="lending">
		SELECT * FROM
		LENDING LEFT JOIN (SELECT * FROM BOOK LEFT JOIN BOOK_INFO USING(ISBN_NO)) USING(BOOK_NO) LEFT JOIN MEMBER USING(USER_ID)
	</select>
	
	<!-- 대출도서 카운트 -->	
	<select id="selectRentalCount" resultType="_int">
		SELECT COUNT(*) FROM LENDING
	</select>
	<!-- 대출도서 검색 리스트 -->
	<select id="SearchRentalList" parameterType="Map" resultMap="lending">
		SELECT * FROM
		LENDING LEFT JOIN (SELECT * FROM BOOK LEFT JOIN BOOK_INFO USING(ISBN_NO)) USING(BOOK_NO) LEFT JOIN MEMBER USING(USER_ID)
		WHERE ${searchOption} LIKE '%'||#{searchWord}||'%'
	</select>
	
	<!-- 대출도서 검색 카운트 -->
	<select id="SearchRentalCount" parameterType="Map" resultType="_int">
		SELECT COUNT(*) FROM
		LENDING LEFT JOIN (SELECT * FROM BOOK LEFT JOIN BOOK_INFO USING(ISBN_NO)) USING(BOOK_NO) LEFT JOIN MEMBER USING(USER_ID)
		WHERE ${searchOption} LIKE '%'||#{searchWord}||'%'
	</select>
	<!-- 대출도서 연장 -->
	<update id="addBookExtend" parameterType="Map">
		UPDATE LENDING SET BOOK_EXTEND=#{bookExtend}, RETURN_DATE=#{returnDate} WHERE USER_ID=#{userId} AND LENDING_NO=#{lendingNo}
	</update>
	
	<!-- resultMap -->
	
	<!-- book -->
	<resultMap type="book" id="bookMap">
		<id column="book_no" property="bookNo"/>
		<result column="isbn_no" property="isbnNo"/> 
		<result column="booking_state" property="bookingState"/>
		<result column="lending_state" property="lendingState"/>
		<collection property="bookInfo" ofType="bookInfo">
			<id column="isbn_no" property="isbnNo"/>
			<result column="book_name" property="bookName"/>
			<result column="book_writer" property="bookWriter"/>
			<result column="book_company" property="bookCompany"/>
			<result column="book_date" property="bookDate"/>
			<result column="book_price" property="bookPrice"/>
			<result column="book_location" property="bookLocation"/>
			<result column="book_content" property="bookContent"/>
			<result column="book_img" property="bookImg"/>
			<result column="book_kdc" property="bookKdc"/>
 			<collection property="kdcDetail" ofType="kdcDetail">
				<id column="kdc_detail_no" property="kdcDetailNo"/>
				<result column="kdc_detail_name" property="kdcDetailName"/>
				<result column="kdc_no" property="kdcNo"/>
				<collection property="kdcType" ofType="kdcType">
					<id column="kdc_no" property="kdcNo"/>
					<result column="kdc_name" property="kdcName"/>
				</collection>
			</collection>
		</collection>
	</resultMap>
			
	<!-- Lending -->		
	<resultMap type="com.kh.klibrary.member.model.vo.Lending" id="lending">
		<id column="LENDING_NO" property="lendingNo"/>
		<result column="USER_ID" property="userId"/>
		<result column="BOOK_NO" property="bookNo"/>
		<result column="LENDING_DATE" property="lendingDate"/>
		<result column="RETURN_DATE" property="returnDate"/>
		<result column="BOOK_EXTEND" property="bookExtend"/>
		<collection property="member" ofType="member">
			<id column="USER_ID" property="userId"/>
			<result column="USER_PASSWORD" property="userPassword"/>
			<result column="USER_NAME" property="userName"/>
			<result column="EMAIL" property="email"/>
			<result column="BIRTH_DATE" property="birthDate"/>
			<result column="ADDRESS" property="address"/>
			<result column="PHONE" property="phone"/>
			<result column="SIGNUP_DATE" property="signupDate"/>
		</collection>
		<collection property="book" ofType="book">
			<id column="BOOK_NO" property="bookNo"/>
			<result column="ISBN_NO" property="bookingState"/>
			<result column="BOOKING_STATE" property="bookingState"/>
			<result column="LENDING_STATE" property="lendingState"/>
			<collection property="bookInfo" ofType="bookInfo">
				<id column="ISBN_NO" property="isbnNo"/>
				<result column="BOOK_NAME" property="bookName"/>
				<result column="BOOK_WRITER" property="bookWriter"/>
				<result column="BOOK_COMPANY" property="bookCompany"/>
				<result column="BOOK_DATE" property="bookDate"/>
				<result column="BOOK_PRICE" property="bookPrice"/>
				<result column="BOOK_LOCATION" property="bookLocation"/>
				<result column="BOOK_CONTENT" property="bookContent"/>
				<result column="BOOK_IMG" property="bookImg"/>
				<result column="BOOK_KDC" property="bookKdc"/>
			</collection>
		</collection>
	</resultMap>
	
	<!-- Lending History -->
	<resultMap id="lenHisMap" type="com.kh.klibrary.member.model.vo.LendingHistory">
		<id column="lending_history_no" property="lendingHistoryNo"/>
		<result column="lending_no" property="lendingNo"/>
		<result column="lending_date" property="lendingDate"/>
		<result column="return_date" property="returnDate"/>
		<result column="book_extend" property="bookExtend"/>
		<result column="book_no" property="bookNo"/>
		<result column="user_id" property="userId"/>
	</resultMap>
	
</mapper>
